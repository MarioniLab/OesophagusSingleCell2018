---
title: "Figure 2: Similarity analysis between BE and other tissues"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Fig_2.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script focuses on the similarity analysis between BE and other tissues: SCJ, GOJ, GC, SMG and D2.

# Read in the data

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
source("../Analysis/Functions/auxiliary.R")
sce <- readRDS("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_corrected_sce.rds")
```

# Visualize GC, GOJ, BE and SCJ samples

Here we perform differential expression (DE) analysis between the epithelial tissues of the GC, GOJ, SCJ, BE and NE samples.

```{r}
# Select tissues to test
cur_corrected <- metadata(sce)$corrected[,sce$include & sce$Tissue %in% c("NE", "GC", "BE", "GOJ", "SCJ")]
cur_sce <- sce[,sce$include & sce$Tissue %in% c("NE", "GC", "BE", "GOJ", "SCJ")]
cur_sce <- normalize(cur_sce)

# Visualize tSNE
p.all.cells <- ggplot(data.frame(tsne1 = reducedDims(cur_sce)$TSNE[,1],
                  tsne2 = reducedDims(cur_sce)$TSNE[,2],
                  tissue = colData(cur_sce)$Tissue)) + 
  geom_point(aes(tsne1, tsne2, colour = tissue)) + 
  scale_color_manual(values = metadata(cur_sce)$colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

# Hierarchical clustering to visualize the tissue relationship
euc.dist <- dist(t(cur_corrected), method = "euclidean")

# Generate matrix for visualization
mat <- matrix(rep(0, ncol(cur_sce)), ncol = ncol(cur_sce), nrow = 1)
colnames(mat) <- paste(cur_sce$Patient, cur_sce$Tissue, cur_sce$Barcode, sep = "_")

# Use pheatmap to visualize samples
pheatmap(mat, clustering_distance_cols = euc.dist, cluster_rows = FALSE,
         show_rownames = FALSE, show_colnames = FALSE,
         annotation_col = data.frame(row.names = colnames(mat),
                                     patient_type = cur_sce$Patient,
                                     cell_type = cur_sce$cell_type,
                                     tissue_type = cur_sce$tissue_type))

pheatmap(mat, cluster_rows = FALSE,
         show_rownames = FALSE, show_colnames = FALSE,
         annotation_col = data.frame(row.names = colnames(mat),
                                     patient_type = cur_sce$Patient,
                                     cell_type = cur_sce$cell_type,
                                     tissue_type = cur_sce$tissue_type))
```

# Plot circular dendrogram of all clusters

To estimate the similarity between all cell types, we compute an averaged expression profile for each cell-type and perform hierarchical cluster analysis.

```{r}
# We will perform this analysis on the corrected and uncorrected counts
clusters <- paste(colData(sce)$Tissue, colData(sce)$Tissue_cluster, sep = "_")
mat <- matrix(data = NA, ncol = length(unique(clusters)), nrow = nrow(metadata(sce)$corrected))
colnames(mat) <- unique(clusters)

for(i in unique(clusters)){
  mat[,i] <- rowMeans(metadata(sce)$corrected[,clusters == i])
}

# Rename the matrix to contain the actual cell-type labels
for(i in 1:ncol(mat)){
  colnames(mat)[i] <- unique(sce$cell_type[sce$Tissue == sub("_[0-9]*$", "", colnames(mat)[i]) &
                                 sce$Tissue_cluster == sub("^[A-Z2]*_", "", colnames(mat)[i])])
}

dend <- hclust(as.dist(sqrt(1 - cor(mat, method = "pearson"))/2), method = "ward.D2")
plot(as.phylo(dend), type = "fan", tip.color = metadata(sce)$colour_vector[sub("_[0-9]*$", "", unique(clusters))])

```

