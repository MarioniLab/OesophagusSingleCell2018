---
title: "Figure 3: differential testing between BE and GC"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Fig_3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, we will find genes that are differentially expressed between GC and BE for stem-like cells and differenitatied cells.

# Read in the data

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(cowplot)
library(RColorBrewer)
library(edgeR)
library(ape)
library(viridis)
library(umap)
source("../Analysis/Functions/auxiliary.R")
sce <- readRDS("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_corrected_sce.rds")
```

# Visualize tissues and global clusters

```{r}
# Select cells of interest
cur_sce <- sce[,sce$include & sce$Tissue %in% c("NE", "GC", "BE", "GOJ", "SCJ", "SMG", "D2")]
cur_sce <- normalize(cur_sce)

# Visualize broad clusters
all_clusters <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                  tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                  clusters = as.factor(cur_sce$Global_cluster))) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters)) +
  xlim(c(-35,40)) + ylim(c(-35,40)) + 
  scale_color_manual(values = c(brewer.pal(8, "Set1"), 
                                brewer.pal(8, "Set2"), 
                                brewer.pal(8, "Set3")))

all_tissues <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                  tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                  clusters = as.factor(cur_sce$Tissue))) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters)) +
  xlim(c(-35,40)) + ylim(c(-35,40)) + 
  scale_color_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/Global_clusters.pdf", all_clusters, width = 10, height = 10)
ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/All_tissues.pdf", all_tissues, width = 10, height = 10)
```

# Calculate entropy per tissue and visualize per cluster

As described in Grun et al, 2016, we use the cell-wise entropy to calculate a possible measure for the stem-like characteristic per cell.

```{r}
# Calculate the entropy within GC
cur_sce <- sce[,sce$include & sce$Tissue == "GC"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Save in form of data.frame
entropy_df <- data.frame(entropy = entropy,
                         tissue = rep("GC", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster)

# Calculate the entropy within BE
cur_sce <- sce[,sce$include & sce$Tissue == "BE"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Save
entropy_df <- rbind(entropy_df, data.frame(entropy = entropy,
                         tissue = rep("BE", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster))

# Calculate the entropy within D2
cur_sce <- sce[,sce$include & sce$Tissue == "D2"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Plot entropy
entropy_df <- rbind(entropy_df, data.frame(entropy = entropy,
                         tissue = rep("D2", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster))

# Plot entropy in form of boxplots
entropy_box <- ggplot(entropy_df) +
  geom_boxplot(aes(as.factor(cluster), entropy, fill = tissue)) +
  scale_fill_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/Entropy.pdf", entropy_box, width = 10, height = 5)
```

# Visualize stem-like cell cluster

Here, we select the cluster that could contain stem-like cells and recluster.

```{r}
# Select cluster 7
cur_sce <- sce[,sce$include & sce$Global_cluster == 7]
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]
cur_sce <- normalize(cur_sce)

# Perform batch correction
sce.list <- split.sce(cur_sce, unique(cur_sce$Sample), colData.name = "Sample")
sce.list <- sce.list[c(which(grepl("GOJ", names(sce.list))),
                       which(grepl("SCJ", names(sce.list))),
                       which(grepl("GC", names(sce.list))),
                       which(grepl("BE", names(sce.list))),
                       which(grepl("D2", names(sce.list))),
                       which(grepl("SMG", names(sce.list))))]
corrected <- batch.correction(sce.list)
cur_sce <- do.call("cbind", sce.list)

# Dimensionality reduction
UMAP <- umap(t(corrected))

UMAP_stemLikeCells <- ggplot(data.frame(UMAP1 = UMAP$layout[,1],
                  UMAP2 = UMAP$layout[,2],
                  tissue = cur_sce$Tissue)) +
  geom_point(aes(UMAP1, UMAP2, colour = tissue)) +
  scale_colour_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/UMAP_stem_cells.pdf", UMAP_stemLikeCells, width = 7, height = 5)
```

# Differential expression testing for progenitor cells between tissues 

Here, we use edgeR to perform DE between progeitor cells of the different tissues.

```{r}

```

