---
title: "Figure 3: differential testing between BE and GC"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Fig_3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Here, we will find genes that are differentially expressed between GC and BE for stem-like cells and differenitatied cells.

# Read in the data

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(cowplot)
library(RColorBrewer)
library(edgeR)
library(ape)
library(viridis)
library(umap)
library(reshape2)
source("../Analysis/Functions/auxiliary.R")
sce <- readRDS("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_corrected_sce.rds")
```

# Visualize tissues and global clusters

```{r}
# Select cells of interest
cur_sce <- sce[,sce$include & sce$Tissue %in% c("NE", "GC", "BE", "GOJ", "SCJ", "SMG", "D2")]
cur_sce <- normalize(cur_sce)

# Visualize broad clusters
all_clusters <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                  tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                  clusters = as.factor(cur_sce$Global_cluster))) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters)) +
  xlim(c(-35,40)) + ylim(c(-35,40)) + 
  scale_color_manual(values = c(brewer.pal(8, "Set1"), 
                                brewer.pal(8, "Set2"), 
                                brewer.pal(8, "Set3")))

all_tissues <- ggplot(data.frame(tSNE1 = reducedDims(cur_sce)$TSNE[,1],
                  tSNE2 = reducedDims(cur_sce)$TSNE[,2],
                  clusters = as.factor(cur_sce$Tissue))) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters)) +
  xlim(c(-35,40)) + ylim(c(-35,40)) + 
  scale_color_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/Global_clusters.pdf", all_clusters, width = 10, height = 10)
ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/All_tissues.pdf", all_tissues, width = 10, height = 10)
```

# Calculate entropy per tissue and visualize per cluster

As described in Grun et al, 2016, we use the cell-wise entropy to calculate a possible measure for the stem-like characteristic per cell.

```{r}
# Calculate the entropy within GC
cur_sce <- sce[,sce$include & sce$Tissue == "GC"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Save in form of data.frame
entropy_df <- data.frame(entropy = entropy,
                         tissue = rep("GC", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster)

# Calculate the entropy within BE
cur_sce <- sce[,sce$include & sce$Tissue == "BE"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Save
entropy_df <- rbind(entropy_df, data.frame(entropy = entropy,
                         tissue = rep("BE", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster))

# Calculate the entropy within D2
cur_sce <- sce[,sce$include & sce$Tissue == "D2"]

# Remove lowly expressed genes
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]

# Bring normalized counts on the real scale
cur_counts <- 2^(logcounts(cur_sce)) - 1

# Calculate entropy
probs   <- t(t(cur_counts)/apply(cur_counts,2,sum))
logprobs <- log(probs)
logprobs[logprobs == -Inf] <- 0
entropy <- -apply(probs*logprobs/log(nrow(cur_sce)),2,sum)

# Plot entropy
entropy_df <- rbind(entropy_df, data.frame(entropy = entropy,
                         tissue = rep("D2", ncol(cur_sce)),
                         cluster = cur_sce$Global_cluster))

# Plot entropy in form of boxplots
entropy_box <- ggplot(entropy_df) +
  geom_boxplot(aes(as.factor(cluster), entropy, fill = tissue)) +
  scale_fill_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/Entropy.pdf", entropy_box, width = 10, height = 5)
```

# Visualize stem-like cell cluster

Here, we select the cluster that could contain stem-like cells and recluster.

```{r}
# Select cluster 7
cur_sce <- sce[,sce$include & sce$Global_cluster == 7]
cur_sce <- cur_sce[Matrix::rowSums(logcounts(cur_sce)) > 0,]
cur_sce <- normalize(cur_sce)

# Perform batch correction
sce.list <- split.sce(cur_sce, unique(cur_sce$Sample), colData.name = "Sample")
sce.list <- sce.list[c(which(grepl("GOJ", names(sce.list))),
                       which(grepl("SCJ", names(sce.list))),
                       which(grepl("GC", names(sce.list))),
                       which(grepl("BE", names(sce.list))),
                       which(grepl("D2", names(sce.list))),
                       which(grepl("SMG", names(sce.list))))]
corrected <- batch.correction(sce.list)
cur_sce <- do.call("cbind", sce.list)

# Dimensionality reduction
UMAP <- umap(t(corrected))

UMAP_stemLikeCells <- ggplot(data.frame(UMAP1 = UMAP$layout[,1],
                  UMAP2 = UMAP$layout[,2],
                  tissue = cur_sce$Tissue)) +
  geom_point(aes(UMAP1, UMAP2, colour = tissue)) +
  scale_colour_manual(values = metadata(cur_sce)$colour_vector)

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/UMAP_stem_cells.pdf", UMAP_stemLikeCells, width = 7, height = 5)
```

# Differential expression testing for progenitor cells between tissues 

Here, we use edgeR to perform DE between progenitor cells of the different tissues.

```{r}
# Define the comparisons
conds <- list(c("BE", "GC"),
              c("BE", "D2"),
              c("BE", "SMG"))

# List to save results
cur_out <- list()

for(i in conds){
  sce_for_test <- cur_sce[,cur_sce$Tissue %in% i] 
  sce_for_test <- sce_for_test[Matrix::rowSums(counts(sce_for_test)) > 0,]
  
  # DE
  cur_DE <- DE.edgeR(sce_for_test, conditions = sce_for_test$Tissue,
           covariate = sce_for_test$Patient,
           lfc = 0.5, FDR = 0.1)
  
  # Label data.frames based by tissue specificity
  cur_DE[[1]]$specificity <- names(cur_DE)[1]
  cur_DE[[2]]$specificity <- names(cur_DE)[2]
  
  # Combine into one dataframe
  new_df <- rbind(cur_DE[[1]], cur_DE[[2]][seq(nrow(cur_DE[[2]]), 1),])
  
  # Save results
  cur_out[[paste(names(cur_DE)[1], names(cur_DE)[2], sep = "_vs_")]] <- new_df
}

# Save results
write.xlsx(cur_out, file = "../../../Dropbox (Cambridge University)/Origin_of_BE_draft/Figures/Supplemental_tables/Table_S7.xlsx")
```

# Perform dimensionality reduction for GC and BE together

To find genes that are cell-type specific and differentially expressed between GC and BE, we focus the analysis only on these 2 tissues.

```{r}
# Select tissues 
cur_sce <- sce[,sce$include & sce$Tissue %in% c("GC", "BE")]

# Deselect cell types that do not match between tissues
cur_sce <- cur_sce[,!(cur_sce$cell_type %in% c("Chief", "Endocrine", "Goblet", "Parietal"))]

# Remove genes that are not expressed
cur_sce <- cur_sce[Matrix::rowSums(counts(cur_sce)) > 0,]
cur_sce <- normalize(cur_sce)

# Perform batch correction
sce.list <- split.sce(cur_sce, unique(cur_sce$Sample), colData.name = "Sample")
sce.list <- sce.list[c(which(grepl("GC", names(sce.list))),
                       which(grepl("BE", names(sce.list))))]
corrected <- batch.correction(sce.list)
cur_sce <- do.call("cbind", sce.list)

# Dimensionality reduction
UMAP <- umap(t(corrected))

UMAP_BE_GC.tissue <- ggplot(data.frame(UMAP1 = UMAP$layout[,1],
                  UMAP2 = UMAP$layout[,2],
                  tissue = cur_sce$Tissue)) +
  geom_point(aes(UMAP1, UMAP2, colour = tissue)) +
  scale_colour_manual(values = metadata(cur_sce)$colour_vector)

# Colour vector for cell-types
colour_vector <- vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Dividing"] <- colorRampPalette(c("white", "#3C5488FF"))(10)[3]
colour_vector["Foveolar_differentiated"] <- colorRampPalette(c("white", "#3C5488FF"))(10)[10]
colour_vector["Foveolar_Intermediate"] <- colorRampPalette(c("white", "#4DBBD5FF"))(10)[6]
colour_vector["Undifferentiated"] <- colorRampPalette(c("white", "#3C5488FF"))(10)[1]

UMAP_BE_GC.cell_type <- ggplot(data.frame(UMAP1 = UMAP$layout[,1],
                  UMAP2 = UMAP$layout[,2],
                  tissue = cur_sce$cell_type)) +
  geom_point(aes(UMAP1, UMAP2), colour = "black", size = 2) +
  geom_point(aes(UMAP1, UMAP2, colour = tissue)) +
  scale_colour_manual(values = colour_vector)

# Save figures
ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/BE_GC_tissue.pdf", UMAP_BE_GC.tissue, width = 7, height = 5)
ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_3/BE_GC_cell_type.pdf", UMAP_BE_GC.cell_type, width = 7, height = 5)
```

# Differential expression testing between cell types

Here, we perform DE between progenitor and differentiated cell types and across tissues.

```{r}

```

