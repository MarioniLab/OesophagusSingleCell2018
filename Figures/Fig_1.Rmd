---
title: "Figure 1: overview on experimental approach and gland cells"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Fig_1.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script visualizes the full dataset as well as highlighting the sub-populations in the gland cells.

# Read in the data

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(viridis)
source("../Analysis/Functions/auxiliary.R")

# Read in the normalized and batch-corrected reads
sce <- readRDS("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_corrected_sce.rds")
```


# Plot tSNE of all cells

Here, we plot the tSNE after batch correction and after removing contaminating cell populations.
The filtering steps are explained in detail in the Methods and Supplementary Note 1.

```{r}
# Remove contaminating cells but leave SMG cells in
include <- colData(sce)$include
include[colData(sce)$Tissue == "SMG"] <- TRUE

p.all.cells <- ggplot(data.frame(tsne1 = reducedDims(sce)$TSNE[include,1],
                  tsne2 = reducedDims(sce)$TSNE[include,2],
                  tissue = colData(sce)$Tissue[include])) + 
  geom_point(aes(tsne1, tsne2, colour = tissue)) + 
  scale_color_manual(values = metadata(sce)$colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_1/All_cells.pdf", 
       p.all.cells, 
       width = 8, height = 7)
```

# Visualize gland cells

To visualize the gland cells, we perform batch correction across all patients and colour cells based on the clustering performed in the Tissue_correction script.

```{r}
cur_sce <- sce[,sce$Tissue == "SMG"]

# Split the SCE object into individual patients
sce.list <- split.sce(cur_sce, unique(cur_sce$Patient), colData.name = "Patient")

# Perform batch correction
corrected <- batch.correction(sce.list)

# Merge sce objects
cur_sce <- do.call("cbind", sce.list)
cur_sce <- normalize(cur_sce)

# Compute tSNE for gland cells
set.seed(111)
smg_tsne <- Rtsne(t(corrected), pca = FALSE)

# Create colour vecotr for glands
colour_vector <-  vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Fibroblast"] <- "grey40"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Serous"] <- "burlywood3"
colour_vector["Endothelial"] <- "grey60"
colour_vector["Nonepithelial"] <- "grey80"
colour_vector["Duct_intercalating"] <- "burlywood4"
colour_vector["Squamous_Esophagus"] <- "black"
colour_vector["Myo-epithelial"] <- "brown"
colour_vector["Dendritic"] <- "grey20"

p.smg <- ggplot(data.frame(tsne1 = smg_tsne$Y[,1],
                  tsne2 = smg_tsne$Y[,2],
                  cell_type = as.factor(cur_sce$cell_type))) + 
  geom_point(aes(tsne1, tsne2, colour = cell_type)) + 
  scale_color_manual(values = colour_vector) + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

ggsave("../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_1/SMG_cells.pdf", 
       p.smg, 
       width = 8, height = 7)
```

# Heatmap visualizing SMG marker genes

Here, we display marker genes selected from the list of cluster-specific marker genes as generated by the Tissue_correction script.

```{r}
genes <- c("KRT7", "TFF3", "MUC5B", "KRT8", "CDH1", "SLPI", 
           "ACTA2", "MMP7", "SOX9", "MKI67", "KRT23", "KRT14",
           "OLFM4", "KRT5")

for.heatmap <- logcounts(cur_sce)[match(genes, rowData(cur_sce)$Symbol),]
colnames(for.heatmap) <- paste(cur_sce$Barcode, cur_sce$Patient, sep = "_")

# Calculate euclidean distance using the factors after batch correction
euc.dist <- dist(t(corrected), method = "euclidean")

# Colouring for patient
patient_vector <- c("dark red", "dark blue", "dark green")
names(patient_vector) <- c("Patient10", "Patient11", "Patient13")

pdf(file = "../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Figure_1/SMG_heatmap.pdf", height = 7, width = 8)
pheatmap(for.heatmap, cluster_rows = FALSE, color = viridis(100), 
         labels_row = genes, show_colnames = FALSE, clustering_distance_cols = euc.dist,
         annotation_col = data.frame(row.names = colnames(for.heatmap),
                                     cell_type = cur_sce$cell_type,
                                     patient = cur_sce$Patient), 
         annotation_colors = list(cell_type = colour_vector,
                                  patient = patient_vector))
dev.off()
```

