---
title: "Figure S3: Comparison of our data to Owen et al and HCA data"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Fig_S3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script visualizes all cells obtained from the gland compartment.
Furthermore, it performs data comparison to data generated by Owen et al [link](https://www.nature.com/articles/s41467-018-06796-9/) and by the Teichmann lab for the Human Cell Atlas.

# Comparison to Owen et al.

```{r libraries, message=FALSE}
library(scran)
library(scater)
library(DropletUtils)
library(openxlsx)
library(Rtsne)
library(pheatmap)
library(viridis)
source("../../Analysis/Functions/auxiliary.R")
```

# Visualizing the gland cells

Here, we visualize the expression of marker genes in gland cells as well as stromal cells.

```{r}
# Read in our data
sce <- readRDS("../../../../Dropbox (Personal)/Oesophagus_single_cell/All_corrected_sce.rds")

# Select gland cells
cur_sce <- sce[,sce$Tissue == "SMG"]

# Split the SCE object into individual patients
sce.list <- split.sce(cur_sce, unique(cur_sce$Patient), colData.name = "Patient")

# Perform batch correction
corrected <- batch.correction(sce.list)

# Merge sce objects
cur_sce <- do.call("cbind", sce.list)

# Create colour vecotr for glands
colour_vector <-  vector(length = length(unique(cur_sce$cell_type)))
names(colour_vector) <- unique(cur_sce$cell_type)
colour_vector["Fibroblast"] <- "grey40"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Doublets.unknown"] <- "white"
colour_vector["Serous"] <- "burlywood3"
colour_vector["Endothelial"] <- "grey60"
colour_vector["Nonepithelial"] <- "grey80"
colour_vector["Duct_intercalating"] <- "burlywood4"
colour_vector["Squamous_Esophagus"] <- "black"
colour_vector["Myo-epithelial"] <- "brown"
colour_vector["Dendritic"] <- "grey20"

# Remove non-expressed genes
cur_sce <- cur_sce[Matrix::rowSums(counts(cur_sce)) > 0,]

genes <- c("CDH1", "TFF3", "MUC5B", "AGR2", "KRT8", "SLPI", 
           "MMP7", "KRT7", "SOX9", "KRT23", "ACTA2", "KRT5",
           "MKI67", "OLFM4")

# We first normalize gene expression across all selected cells
cur_sce <- computeSumFactors(cur_sce, clusters=cur_sce$cell_type)
cur_sce <- normalize(cur_sce, return_log = TRUE)

# Remove somatic cells
for.heatmap <- logcounts(cur_sce)[match(genes, rowData(cur_sce)$Symbol),]
colnames(for.heatmap) <- paste(cur_sce$Barcode, cur_sce$Patient, sep = "_")

# Calculate euclidean distance using the factors after batch correction
euc.dist <- dist(t(corrected), method = "euclidean")

# Colouring for patient
patient_vector <- c("dark red", "dark blue", "dark green")
names(patient_vector) <- c("Patient10", "Patient11", "Patient13")

pdf(file = "../../../../Dropbox (Personal)/Oesophagus_single_cell/Results/Figures/Supplementary_figures/S2/SMG_heatmap_all.pdf", height = 7, width = 8)
pheatmap(for.heatmap, cluster_rows = FALSE, color = viridis(100), 
         labels_row = genes, show_colnames = FALSE, clustering_distance_cols = euc.dist,
         annotation_col = data.frame(row.names = colnames(for.heatmap),
                                     cell_type = cur_sce$cell_type,
                                     patient = cur_sce$Patient), 
         annotation_colors = list(cell_type = colour_vector,
                                  patient = patient_vector))
dev.off()

```


# Comparison to Owen et al.

We will first read in the raw data and metadata from Owne et al.

```{r}
# Owen read counts
owen.data <- read.table(url("https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06796-9/MediaObjects/41467_2018_6796_MOESM8_ESM.txt"))

# Rename columns
colnames(owen.data) <- as.character(sapply(colnames(owen.data), function(n){paste(unlist(strsplit(n, "_"))[3:5], collapse = "_")}))

# Owen metadata
owen.meta <- read.table(url("https://static-content.springer.com/esm/art%3A10.1038%2Fs41467-018-06796-9/MediaObjects/41467_2018_6796_MOESM9_ESM.txt"), header = TRUE)

# Reorder cells based on metadata
owen.data <- owen.data[,as.character(owen.meta$sample_id)]
```

## Preporcessing of Owen et al data

We will now generate a `SingleCellExperiment` object that contains the Owen et al data.
To allow correct comparisons, we will perform quality assesment and filtering on the Owen at al data.

```{r}
# Remove genes that contain NA
owen.data <- owen.data[!is.na(rowSums(owen.data)),]

# Remove ERCC counts 
owen.data <- owen.data[!grepl("ERCC", rownames(owen.data)),]

# Build the SCE object
sce.owen <- SingleCellExperiment(assays = list(counts = as(as.matrix(owen.data), "dgCMatrix")),
                                 colData = as.data.frame(owen.meta))
# Remove low quality cells
# The coloumn data contains the cluster ID of each cell
# If the cell is not part of any cluster, we remove them
sce.owen <- sce.owen[,apply(colData(sce.owen), 1, function(n){sum(is.na(n))/7}) != 1]

# Visualize quality
sce.owen <- calculateQCMetrics(sce.owen)

ggplot(as.data.frame(colData(sce.owen))) +
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = tissue))
ggplot(as.data.frame(colData(sce.owen))) +
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = all_k8))

# Remove cells with few genes expressed (blanks as these will distort the normalization)
sce.owen <- sce.owen[,colData(sce.owen)$total_features_by_counts > 1000]

# Normalize the data
cluster <- quickCluster(sce.owen, method = "igraph", irlba.args = c("work" = 100), 
                         max.size = 2000, min.size = 50)
sce.owen <- computeSumFactors(sce.owen, clusters=cluster)
sce.owen <- normalize(sce.owen, return_log = TRUE)
```

# Map owen data onto our data

In the next step, we use the mnn mapping approach to merge our data with the data from Owen et al. 

```{r}
# Match rownames
genes <- intersect(rownames(sce.owen), rownames(sce))
sce.owen <- sce.owen[genes,]
sce <- sce[genes,]

# Exclude contaminating cells
sce <- sce[,sce$include]
sce <- normalize(sce)

# Generate list of SCE object for batch correction
sce.list <- split.sce(sce, unique(sce$Patient), colData.name = "Patient")
sce.list <- lapply(sce.list, function(n){split.sce(n, unique(n$Tissue), colData.name = "Tissue")})
sce.list <- unlist(sce.list)

# Sort list for mapping
sce.list <- sce.list[c("Patient2.NE", "Patient7.NE", "Patient8.NE", "Patient10.NE",
                       "Patient2.GOJ", "Patient8.GOJ", "Patient10.GOJ", "Patient13.GOJ",
                       "Patient3.SCJ", "Patient7.SCJ", "Patient9.SCJ", 
                       "Patient2.GC", "Patient7.GC", "Patient3.GC", "Patient13.GC", 
                       "Patient3.BE", "Patient7.BE", "Patient9.BE",
                       "Patient7.D2", "Patient8.D2", "Patient9.D2", "Patient12.D2",
                       "Patient10.SMG", "Patient11.SMG", "Patient13.SMG")]

# Split Owen data into list
owen.list <- split.sce(sce.owen, unique(sce.owen$patient), colData.name = "patient")
owen.list <- lapply(owen.list, function(n){split.sce(n, unique(n$tissue), colData.name = "tissue")})
owen.list <- unlist(owen.list)

# Remove batches that contain few than 10 cells
owen.list <- owen.list[lapply(owen.list, ncol) > 10]

# Sort list for mapping
owen.list <- owen.list[c("PtA.Oesophagus", "PtD.Oesophagus", "PtE.Oesophagus", "PtF.Oesophagus",
                         "PtA.Gastric", "PtC.Gastric", "PtD.Gastric",
                         "PtA.Barrett's", "PtC.Barrett's", "PtD.Barrett's",  "PtB.Barrett's",
                         "PtA.Duodenum", "PtC.Duodenum", "PtD.Duodenum", "PtB.Duodenum",
                         "Control.Brain")]

# Collect tissue information
tissues <- unlist(lapply(sce.list, function(n){n$Tissue}))
tissues.all <- c(tissues, as.character(unlist(lapply(owen.list, function(n){n$tissue}))))

# Add Owen data to sce
sce.list <- c(sce.list, owen.list)
set.seed(12345)
corrected <- batch.correction(sce.list)

# Visualize results
set.seed(123)
tsne <- Rtsne(t(corrected), pca = FALSE, perplexity = 100)

# Extend the colour vector
owen_vector <- vector(length = length(unique(sce.owen$tissue)))
names(owen_vector) <- unique(sce.owen$tissue)
owen_vector["Barrett's"] <- metadata(sce)$colour_vector["BE"]
owen_vector["Oesophagus"] <- metadata(sce)$colour_vector["NE"]
owen_vector["Gastric"] <- metadata(sce)$colour_vector["GC"]
owen_vector["Duodenum"] <- metadata(sce)$colour_vector["D2"]
owen_vector["Brain"] <- "black"

colour_vector <- c(metadata(sce)$colour_vector, 
                   owen_vector)

# Number of cells in owen dataset
n.owen <- sum(unlist(lapply(owen.list, ncol)))

owen.all.tissues <- ggplot() +
    geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-n.owen),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-n.owen),2],
    tissue = tissues.all[1:(ncol(corrected)-n.owen)]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) +
    geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-n.owen+1):ncol(corrected)]
    ), 
    aes(tsne1, tsne2), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-n.owen+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-n.owen+1):ncol(corrected)]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) + 
  scale_color_manual(values = colour_vector) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

# Visualize tissue composition of gland like cells
tissue.gland <- c(rep(NA, length(tissues)), 
                  as.character(unlist(lapply(owen.list, function(n){n$gland_cells_k3}))))
gland.groups.tissues <- ggplot() +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-n.owen),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-n.owen),2],
    tissue = tissues.all[1:(ncol(corrected)-n.owen)]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2]), 
    aes(tsne1, tsne2), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[!is.na(tissue.gland),1],
    tsne2 = tsne$Y[!is.na(tissue.gland),2],
    tissue = tissues.all[!is.na(tissue.gland)]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) + 
  scale_color_manual(values = colour_vector) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

# Save plots
ggsave("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Supplementary_figures/Figure_S3/All_owen_data.pdf", owen.all.tissues, width = 6, height = 5)
ggsave("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Supplementary_figures/Figure_S3/Glandlike_owen_data.pdf", gland.groups.tissues, width = 6, height = 5)
```

# Comparison to HCA data

We next compare our data to normal oesophagus samples from different patients.
This data has been generated in the context of the Human Cell Atlas.
Here, we want to check whether gland cells can be detected by simply sampling thousands of cells from normal oesophagus.

We remove one patient due to differences in the dissociation protocol.

```{r}
# Read in the HCA data
HCA.sce <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Teichman_data/Data/Teichmann_data_small.rds")

# Remove donor 296C
HCA.sce <- HCA.sce[,HCA.sce$Donor != "296C"]

# Normalization
cluster <- quickCluster(HCA.sce, method = "igraph", irlba.args = c("work" = 100), 
                         max.size = 2000, min.size = 50)
HCA.sce <- computeSumFactors(HCA.sce, clusters=cluster)
HCA.sce <- normalize(HCA.sce, return_log = TRUE)

# For our data, we select the normal oesophagus an gland cells
sce <- sce[,sce$Tissue == "NE" | sce$Tissue == "SMG"]
sce <- normalize(sce)

# Select the same set of genes for both datasets
genes <- intersect(rownames(HCA.sce), rowData(sce)$Symbol)
HCA.sce <- HCA.sce[genes,]
sce <- sce[match(genes, rowData(sce)$Symbol),]
rownames(sce) <- genes

# Split the data into individual batches
sce.list <- split.sce(sce, groups = unique(sce$Sample), colData.name = "Sample")

# Add the Teichmann data to this list
sce.list <- c(sce.list, split.sce(HCA.sce, unique(HCA.sce$Donor), colData.name = "Donor"))

# Batch correction and merging
corrected <- batch.correction(sce.list)
sce <- do.call("cbind", split.sce(sce, groups = unique(sce$Sample), colData.name = "Sample"))
HCA.sce <- do.call("cbind", split.sce(HCA.sce, groups = unique(HCA.sce$Donor), colData.name = "Donor"))

# Generate tissue vector - we colour the gland cells based on their cell type
tissues.all <- c(sce$Tissue, rep("NE", ncol(HCA.sce)))
tissues.all[tissues.all == "SMG"] <- sce$cell_type[sce$Tissue == "SMG"]

# Generate new colour vector
colour_vector <- vector(length = length(unique(tissues.all)))
names(colour_vector) <- unique(tissues.all)
colour_vector["Fibroblast"] <- "grey40"
colour_vector["Mucous"] <- "saddlebrown"
colour_vector["Serous"] <- "burlywood3"
colour_vector["Endothelial"] <- "grey60"
colour_vector["Nonepithelial"] <- "grey80"
colour_vector["Duct_intercalating"] <- "burlywood4"
colour_vector["Squamous_Esophagus"] <- "black"
colour_vector["Myo-epithelial"] <- "brown"
colour_vector["Dendritic"] <- "grey20"
colour_vector["NE"] <- "dark red"

# Visualization of mapped data
set.seed(12345)
tsne <- Rtsne(t(corrected), perplexity = 100, pca = FALSE)

# Visualization
HCA.all.cells <- ggplot() +
    geom_point(data = data.frame(
    tsne1 = tsne$Y[1:(ncol(corrected)-ncol(HCA.sce)),1],
    tsne2 = tsne$Y[1:(ncol(corrected)-ncol(HCA.sce)),2],
    tissue = tissues.all[1:(ncol(corrected)-ncol(HCA.sce))]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) +
    geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected)]
    ), 
    aes(tsne1, tsne2), size = 2, colour = "black") +
  geom_point(data = data.frame(
    tsne1 = tsne$Y[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected),1],
    tsne2 = tsne$Y[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected),2],
    tissue = tissues.all[(ncol(corrected)-ncol(HCA.sce)+1):ncol(corrected)]
    ), 
    aes(tsne1, tsne2, colour = tissue), size = 1) + 
  scale_color_manual(values = colour_vector) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "grey"))

ggsave("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Figures/Supplementary_figures/Figure_S3/HCA_data.pdf", HCA.all.cells, width = 10, height = 8)
```

