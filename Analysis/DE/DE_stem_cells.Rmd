---
title: "Differential expression in stem cell compartment"
author: "Nils Eling"
date: "10/09/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script performs differential expression between the stem cells of different tissues.

## Read in the data 

```{r data}
library(scater)
library(scran)
library(edgeR)
sce <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_corrected_sce.rds")

# Select all OLFM4 cells
sce_olfm4 <- sce[,logcounts(sce)[rowData(sce)$Symbol == "OLFM4",] > 0]
plot(table(colData(sce_olfm4)$Tissue))
```

# GC vs BE

```{r}
sce.test <- sce_olfm4[,grepl("BE|GC", colData(sce_olfm4)$Tissue)]
sce.test <- sce.test[Matrix::rowMeans(logcounts(sce.test)) > 0.1,]
sce.test <- normalize(sce.test)
  
# Sum counts with each batch and group
mat <- matrix(data = NA, ncol = length(unique(paste(colData(sce.test)$Patient, 
                                        colData(sce.test)$Tissue, sep = "_"))), 
              nrow = nrow(counts(sce.test)))
rownames(mat) <- rownames(counts(sce.test))
colnames(mat) <- unique(paste(colData(sce.test)$Patient, 
                                colData(sce.test)$Tissue, sep = "_"))
  
for(j in colnames(mat)){
  cur_batch <- unlist(strsplit(j, "_"))[2]
  mat[,j] <- Matrix::rowSums(counts(sce.test)[,colData(sce.test)$Library == cur_batch]) 
}
  
# Perform differential testing
y <- DGEList(counts=mat,
             group=sapply(colnames(mat), 
                          function(n){unlist(strsplit(n, "_"))[1]}))
y <- calcNormFactors(y)
design <- model.matrix(~0+sapply(colnames(mat), function(n){unlist(strsplit(n, "_"))[1]}))
colnames(design) <- c("Tc0", "Tc1")
y <- estimateDisp(y,design)
  
fit <- glmQLFit(y,design, robust = TRUE)
qlf <- glmTreat(fit,coef=2, lfc = 0.5, 
                contrast = makeContrasts(Tc1 - Tc0, levels = design))
cur_markers <- topTags(qlf, n = nrow(qlf$table))$table
  
```