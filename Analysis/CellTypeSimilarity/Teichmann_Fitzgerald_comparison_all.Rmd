---
title: "Comparison of Teichmann and Fitzgerald data"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Results/Reports/Teichmann_Fitzgerald_comparison_all.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script compares data generated by the Teichmann lab versus data generated by the Fitzgerald lab.
Here, I will use all samples, also the ones that we removed to due quality issues.
I will start with raw counts and select the conditions of interest.
For convenience, the analysis is performed using `scran`.

The first step is to select oesophagus cells from the Teichmann lab at 0-6 hours after sampling.

## Select condition of interest

```{r select-condition, eval=FALSE}
library(scran)
library(Seurat)
library(SingleCellExperiment)

# Read in the Teichmann data
T.data <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Teichman_data/Data/Oesophagus_QC_TSNE_alldonors.gz")
T.meta <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Teichman_data/Data/oesophagus_QC_TSNE_alldonors_bbknn_UMAP_meta.gz")

# Strip out the data that we don't need for easier handling
T.data@data <- NULL
T.data@scale.data <- NULL

# Form a SingleCellExpression Object
T.sce <- SingleCellExperiment(assays = list(counts = T.data@raw.data))

# There seems to be a discrepancy between the cells in the metdata object and the Seurat object
ncol(T.data@raw.data)
nrow(T.meta)

# I will therefore only retain the cells that are in the metadata object
T.sce <- T.sce[,rownames(T.meta)]

# Save the metadata in the colData slot
colData(T.sce) <- DataFrame(T.meta) 

# Since we are only interested in the 0h time-point, I subset the dataset to exactly this collection time
T.sce <- T.sce[,T.sce$Time == "0h"]
dim(T.sce)

# I retain 17276 genes and 14478 cells

# Save object
saveRDS(T.sce, "../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Teichman_data/Data/Teichmann_data_small.rds")
```

## Analysis of Teichmann data

I will do a quick analysis of the data to get an idea about the cell-types present and the patient effect.
The first step is to normalize the data by pooling similar cells and deconvolving cell-specific normalization factors.

```{r analysis, message=FALSE}
library(scran)
library(umap)
library(ggplot2)
library(RColorBrewer)
library(Rtsne)
source("../../Analysis/Functions/auxiliary.R")
T.sce <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/Teichman_data/Data/Teichmann_data_small.rds")

# Normalization
T.sce <- computeSumFactors(T.sce)
T.sce <- normalize(T.sce)

# Compute tSNE on the most highly variable genes
HVGs <- HVG(T.sce)
set.seed(1234)
T.tsne <- Rtsne(t(as.matrix(logcounts(T.sce)[HVGs,])))

ggplot(data.frame(tSNE1 = T.tsne$Y[,1],
                  tSNE2 = T.tsne$Y[,2],
                  patient = factor(T.sce$Donor))) + 
  geom_point(aes(tSNE1, tSNE2, colour = patient)) +
  scale_color_brewer(palette = "Set1")

# As expected, there is a strong patient effect
# I will correct this using mnncorrect
# Split sce object into individual patients
sce.list <- split.sce(T.sce, unique(T.sce$Donor), colData.name = "Donor")
corrected <- batch.correction(sce.list)
T.sce <- do.call("cbind", sce.list)

# Recalculate tSNE on corrected counts
set.seed(1234)
T.tsne <- Rtsne(t(corrected), perplexity = 100, pca = FALSE)

ggplot(data.frame(tSNE1 = T.tsne$Y[,1],
                  tSNE2 = T.tsne$Y[,2],
                  patient = factor(T.sce$Donor))) + 
  geom_point(aes(tSNE1, tSNE2, colour = patient)) +
  scale_color_brewer(palette = "Set1")

# There appears to be a remaining sample effect from Donor 296C
```

### Clustering and marker gene detection

Here, I visualize the initial clustering and detect marker genes to determine the cell types in the samples.

```{r}
# Visualization of original clustering results
ggplot(data.frame(tSNE1 = T.tsne$Y[,1],
                  tSNE2 = T.tsne$Y[,2],
                  clusters = factor(T.sce$bbknn.umap.clusters))) + 
  geom_point(aes(tSNE1, tSNE2, colour = clusters)) +
  scale_color_manual(values = c(brewer.pal(n = 8, "Set1"), 
                                brewer.pal(n = 12, "Set3")))

table(T.sce$Donor, T.sce$bbknn.umap.clusters)

# Cluster 11 is primarily occupied by Donor 296C
```

This Donor effect is something that we have also seen. 
bbknn and mnn don't seem to correct this effect which means it has to be something biological or a strong technical effect. 

## Mapping the Teichmann data to our data

I will next map the Teichmann data to the Fitsgerald data to compare cell type compositions between the two different datasets.

```{r mapping, fig.height=7, fig.width=7}
F.sce <- readRDS("../../../../Dropbox (Cambridge University)/Oesophagus_single_cell/All_sce.rds")

# Select the condtions that we want to use for mapping
F.sce <- F.sce[grepl("NE|SMG", names(F.sce))]

# Select the same set of genes for both datasets
genes <- intersect(rownames(T.sce), rowData(F.sce$Patient1_SIGAE2_NE)$Symbol)
T.sce <- T.sce[genes,]
F.sce <- lapply(F.sce, function(n){
  cur_sce <- n[match(genes, rowData(n)$Symbol),]
  rownames(cur_sce) <- genes
  rowData(cur_sce) <- rowData(cur_sce)[,1:2]
  cur_sce
})

# Add the Teichmann data to this list
sce.list <- c(F.sce, split.sce(T.sce, unique(T.sce$Donor), colData.name = "Donor"))

# Batch correction and merging
corrected <- batch.correction(sce.list)
F.sce <- do.call("cbind", F.sce)
T.sce <- do.call("cbind", split.sce(T.sce, groups = unique(T.sce$Donor), colData.name = "Donor"))
F.sce <- normalize(F.sce)
T.sce <- normalize(T.sce)

# Visualization of mapped data
set.seed(12345)

tsne <- Rtsne(t(corrected), perplexity = 100, pca = FALSE)
umap.all <- umap(t(corrected))

# Visualization of mapping results
# Dataset source
ggplot(data.frame(tSNE1 = tsne$Y[,1],
                  tSNE2 = tsne$Y[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))))) + 
  geom_point(aes(tSNE1, tSNE2, colour = dataset, size = dataset)) +
  scale_colour_manual(values = c("black", "red")) +
  scale_size_manual(values = c(1,0.3))

ggplot(data.frame(UMAP1 = umap.all$layout[,1],
                  UMAP2 = umap.all$layout[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))))) + 
  geom_point(aes(UMAP1, UMAP2, colour = dataset, size = dataset)) +
  scale_colour_manual(values = c("black", "red")) +
  scale_size_manual(values = c(1,0.3))

# Tissue type
ggplot(data.frame(tSNE1 = tsne$Y[,1],
                  tSNE2 = tsne$Y[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))),
                  Tissue = factor(c(F.sce$Tissue,
                                     rep("Oesophagus", ncol(T.sce)))))) + 
  geom_point(aes(tSNE1, tSNE2, colour = Tissue, size = dataset)) +
  scale_colour_manual(values = brewer.pal(n = 8, "Set1")) +
  scale_size_manual(values = c(1,0.3))

ggplot(data.frame(UMAP1 = umap.all$layout[,1],
                  UMAP2 = umap.all$layout[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))),
                  Tissue = factor(c(F.sce$Tissue,
                                     rep("Oesophagus", ncol(T.sce)))))) + 
  geom_point(aes(UMAP1, UMAP2, colour = Tissue, size = dataset)) +
  scale_colour_manual(values = brewer.pal(n = 8, "Set1")) +
  scale_size_manual(values = c(1,0.3))

# Patient dataset specific
ggplot(data.frame(tSNE1 = tsne$Y[1:ncol(F.sce),1],
                  tSNE2 = tsne$Y[1:ncol(F.sce),2],
                  dataset = factor(rep("Fitzgerald", ncol(F.sce))),
                  Patient = factor(F.sce$Patient))) + 
  geom_point(aes(tSNE1, tSNE2, colour = Patient)) +
  scale_colour_manual(values = c(brewer.pal(n = 8, "Set1"),
                                 brewer.pal(n = 8, "Set3")))

ggplot(data.frame(tSNE1 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),1],
                  tSNE2 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),2],
                  dataset = factor(rep("Teichmann", ncol(T.sce))),
                  Patient = factor(as.character(T.sce$Donor)))) + 
  geom_point(aes(tSNE1, tSNE2, colour = Patient)) +
  scale_colour_manual(values = c(brewer.pal(n = 8, "Set1"),
                                 brewer.pal(n = 8, "Set3"))) 

ggplot(data.frame(UMAP1 = umap.all$layout[,1],
                  UMAP2 = umap.all$layout[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))),
                  Patient = factor(c(F.sce$Patient,
                                     as.character(T.sce$Donor))))) + 
  geom_point(aes(UMAP1, UMAP2, colour = Patient, size = dataset)) +
  scale_colour_manual(values = c(brewer.pal(n = 8, "Set1"),
                                 brewer.pal(n = 8, "Set3"))) +
  scale_size_manual(values = c(1,0.3))

# Clusters
ggplot(data.frame(tSNE1 = tsne$Y[,1],
                  tSNE2 = tsne$Y[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))),
                  Cluster = factor(c(F.sce$Tissue,
                                     as.character(T.sce$bbknn.umap.clusters))))) + 
  geom_point(aes(tSNE1, tSNE2, colour = Cluster, size = dataset)) +
  scale_colour_manual(values = c(brewer.pal(n = 8, "Set1"),
                                 brewer.pal(n = 8, "Set3"),
                                 brewer.pal(n = 8, "Paired"))) +
  scale_size_manual(values = c(1,0.3))

ggplot(data.frame(UMAP1 = umap.all$layout[,1],
                  UMAP2 = umap.all$layout[,2],
                  dataset = factor(c(rep("Fitzgerald", ncol(F.sce)),
                                     rep("Teichmann", ncol(T.sce)))),
                  Cluster = factor(c(F.sce$Tissue,
                                     as.character(T.sce$bbknn.umap.clusters))))) + 
  geom_point(aes(UMAP1, UMAP2, colour = Cluster, size = dataset)) +
  scale_colour_manual(values = c(brewer.pal(n = 8, "Set1"),
                                 brewer.pal(n = 8, "Set3"),
                                 brewer.pal(n = 8, "Paired"))) +
  scale_size_manual(values = c(1,0.3))

# Marker gene expression
# Normal oesophagus
for(i in c("KRT5", "KRT14", "KRT4", "ECM1", "KRT14")){
  # Plot Fitzgerald data first
  print(ggplot(data.frame(tSNE1 = tsne$Y[1:ncol(F.sce),1],
                  tSNE2 = tsne$Y[1:ncol(F.sce),2],
                  gene = logcounts(F.sce)[i,])) + 
  geom_point(aes(tSNE1, tSNE2, colour = gene)) +
  scale_colour_viridis_c(name = paste(i, "Fitzgerald"))) 
    
  print(ggplot(data.frame(tSNE1 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),1],
                  tSNE2 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),2],
                  gene = logcounts(T.sce)[i,])) + 
  geom_point(aes(tSNE1, tSNE2, colour = gene)) +
  scale_colour_viridis_c(name = paste(i, "Teichmann"))) 
}


# Gland cells
for(i in c("KRT7", "TFF3", "MUC5B", "SLPI", "RBP1", "KRT23")){
  # Plot Fitzgerald data first
  print(ggplot(data.frame(tSNE1 = tsne$Y[1:ncol(F.sce),1],
                  tSNE2 = tsne$Y[1:ncol(F.sce),2],
                  gene = logcounts(F.sce)[i,])) + 
  geom_point(aes(tSNE1, tSNE2, colour = gene)) +
  scale_colour_viridis_c(name = paste(i, "Fitzgerald"))) 
    
  print(ggplot(data.frame(tSNE1 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),1],
                  tSNE2 = tsne$Y[(ncol(F.sce)+1):(ncol(F.sce)+ncol(T.sce)),2],
                  gene = logcounts(T.sce)[i,])) + 
  geom_point(aes(tSNE1, tSNE2, colour = gene)) +
  scale_colour_viridis_c(name = paste(i, "Teichmann")))
}

```